From b676a29210f8396d81b4d2b9d89c2c972738ab97 Mon Sep 17 00:00:00 2001
From: Ratheesh Kannoth <rkannoth@codeaurora.org>
Date: Mon, 13 Jul 2020 10:35:07 +0530
Subject: [PATCH] net: openvswitch: Use sleepable rcu

Signed-off-by: Ratheesh Kannoth <rkannoth@codeaurora.org>
Change-Id: Iab03855cb7f9cd2a7b584fa22780adf6772b92f1
---
 net/openvswitch/datapath.c | 44 +++++++++++++++++++++-----------------
 1 file changed, 24 insertions(+), 20 deletions(-)

--- a/net/openvswitch/datapath.c
+++ b/net/openvswitch/datapath.c
@@ -48,7 +48,8 @@
 #include "vport-netdev.h"
 
 unsigned int ovs_net_id __read_mostly;
-static struct ovs_accel_callback *ovs_accel_cb;
+static struct ovs_accel_callback __rcu *ovs_accel_cb;
+static struct srcu_struct ovs_accel_cb_sp_rcu;
 
 static struct genl_family dp_packet_genl_family;
 static struct genl_family dp_flow_genl_family;
@@ -224,12 +225,11 @@ void ovs_dp_detach_port(struct vport *p)
 static void ovs_dp_add_notify(struct datapath *dp, struct vport *vp)
 {
 	struct ovs_accel_callback *ovs_cb;
-
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_add)
 		ovs_cb->ovs_accel_dp_add((void *)dp, vp->dev);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath delete event to acceleration callback */
@@ -237,11 +237,11 @@ static void ovs_dp_del_notify(struct dat
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_del)
 		ovs_cb->ovs_accel_dp_del((void *)dp, vp->dev);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath port add event to acceleration callback */
@@ -250,17 +250,18 @@ static void ovs_dp_port_add_notify(struc
 {
 	struct ovs_accel_callback *ovs_cb;
 	const char *master = NULL;
+	int idx;
 
 	if (a[OVS_VPORT_ATTR_MASTER])
 		master = nla_data(a[OVS_VPORT_ATTR_MASTER]);
 
-	rcu_read_lock();
+	idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_port_add)
 		ovs_cb->ovs_accel_dp_port_add((void *)dp, (void *)vp,
 					      vp->port_no, vp->ops->type,
 					      master, vp->dev);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath port delete event to acceleration callback */
@@ -268,11 +269,11 @@ static void ovs_dp_port_del_notify(struc
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_port_del)
 		ovs_cb->ovs_accel_dp_port_del((void *)dp, (void *)vp, vp->dev);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath flow add event to acceleration callback */
@@ -280,11 +281,11 @@ static void ovs_dp_flow_add_notify(struc
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_flow_add)
 		ovs_cb->ovs_accel_dp_flow_add((void *)dp, sf);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath flow delete event to acceleration callback */
@@ -292,11 +293,11 @@ static void ovs_dp_flow_del_notify(struc
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_flow_del)
 		ovs_cb->ovs_accel_dp_flow_del((void *)dp, sf);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath flow table flush event to acceleration callback */
@@ -304,11 +305,11 @@ static void ovs_dp_flow_tbl_flush_notify
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_flow_tbl_flush)
 		ovs_cb->ovs_accel_dp_flow_tbl_flush((void *)dp);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Notify datapath flow set/change event to acceleration callback */
@@ -317,11 +318,11 @@ static void ovs_dp_flow_set_notify(struc
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	rcu_read_lock();
+	int idx = srcu_read_lock(&ovs_accel_cb_sp_rcu);
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_flow_set)
 		ovs_cb->ovs_accel_dp_flow_set((void *)dp, sf, new_sfa);
-	rcu_read_unlock();
+	srcu_read_unlock(&ovs_accel_cb_sp_rcu, idx);
 }
 
 /* Forward datapath packet to acceleration callback
@@ -333,8 +334,6 @@ static void ovs_dp_pkt_process_notify(st
 {
 	struct ovs_accel_callback *ovs_cb;
 
-	WARN_ON(!rcu_read_lock_held());
-
 	ovs_cb = rcu_dereference(ovs_accel_cb);
 	if (ovs_cb && ovs_cb->ovs_accel_dp_pkt_process)
 		ovs_cb->ovs_accel_dp_pkt_process((void *)dp, skb, key, sf, sfa);
@@ -2536,6 +2535,7 @@ int ovs_register_accelerator(struct ovs_
 
 	rcu_assign_pointer(ovs_accel_cb, oac);
 	ovs_unlock();
+	synchronize_srcu(&ovs_accel_cb_sp_rcu);
 	return 0;
 }
 EXPORT_SYMBOL(ovs_register_accelerator);
@@ -2546,6 +2546,7 @@ void ovs_unregister_accelerator(struct o
 	ovs_lock();
 	rcu_assign_pointer(ovs_accel_cb, NULL);
 	ovs_unlock();
+	synchronize_srcu(&ovs_accel_cb_sp_rcu);
 }
 EXPORT_SYMBOL(ovs_unregister_accelerator);
 
@@ -2950,6 +2951,8 @@ static int __init dp_init(void)
 
 	pr_info("Open vSwitch switching datapath\n");
 
+	init_srcu_struct(&ovs_accel_cb_sp_rcu);
+
 	err = action_fifos_init();
 	if (err)
 		goto error;
@@ -2999,6 +3002,7 @@ error_unreg_rtnl_link:
 error_action_fifos_exit:
 	action_fifos_exit();
 error:
+	cleanup_srcu_struct(&ovs_accel_cb_sp_rcu);
 	return err;
 }
 
