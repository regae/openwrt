From cda538595d8eb91bade8a24ebaef007da1bdfd25 Mon Sep 17 00:00:00 2001
From: Suman Ghosh <sumaghos@codeaurora.org>
Date: Fri, 18 Oct 2019 11:26:26 +0530
Subject: [PATCH] net: core: skbuff: Update locking mechanism for skbuff
 recycler count

Change-Id: I0d03dba63cabdb80e9906fac2e75ea968e6cc075
Signed-off-by: Suman Ghosh <sumaghos@codeaurora.org>
---
 net/core/skbuff_recycle.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/net/core/skbuff_recycle.c
+++ b/net/core/skbuff_recycle.c
@@ -281,6 +281,7 @@ static int proc_skb_count_show(struct se
 	int total;
 #ifdef CONFIG_SKB_RECYCLER_MULTI_CPU
 	unsigned int i;
+	unsigned long flags;
 #endif
 
 	total = 0;
@@ -298,13 +299,13 @@ static int proc_skb_count_show(struct se
 		total += len;
 	}
 
-	spin_lock(&glob_recycler.lock);
 	for (i = 0; i < SKB_RECYCLE_MAX_SHARED_POOLS; i++) {
+		spin_lock_irqsave(&glob_recycler.lock, flags);
 		len = skb_queue_len(&glob_recycler.pool[i]);
+		spin_unlock_irqrestore(&glob_recycler.lock, flags);
 		seq_printf(seq, "global_list[%d]: %d\n", i, len);
 		total += len;
 	}
-	spin_unlock(&glob_recycler.lock);
 #endif
 
 	seq_printf(seq, "total: %d\n", total);
