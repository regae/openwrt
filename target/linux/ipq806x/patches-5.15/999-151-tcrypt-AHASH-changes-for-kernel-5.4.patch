From 4c657bc08607d9a0c980cab8550a4d86c4662a10 Mon Sep 17 00:00:00 2001
From: Pavithra R <pavir@codeaurora.org>
Date: Thu, 26 Oct 2017 19:23:49 -0700
Subject: [PATCH] [tcrypt] AHASH changes for kernel 5.4.

This patch has changes to be incorporated for AHASH tests

Change-Id: Icb0e90b62103f35915a2a5960725a6f45a222aef
Signed-off-by: Pavithra R <pavir@codeaurora.org>
---
 crypto/Kconfig   | 18 ++++++++++++++++++
 crypto/testmgr.c | 30 ++++++++++++++++++++++++------
 2 files changed, 42 insertions(+), 6 deletions(-)

--- a/crypto/Kconfig
+++ b/crypto/Kconfig
@@ -231,6 +231,24 @@ config CRYPTO_DISABLE_AHASH_LARGE_KEY_TE
 	help
 	  Disable large key ahash tests
 
+config CRYPTO_DISABLE_AHASH_TYPE1_TESTS
+	bool "Disable AHASH type 1 test cases"
+	default y
+	help
+	  Disable AHASH type 1 tests
+
+config CRYPTO_DISABLE_AHASH_TYPE2_TESTS
+	bool "Disable AHASH type 2 test cases"
+	default y
+	help
+	  Disable AHASH type 2 tests
+
+config CRYPTO_DISABLE_AHASH_TYPE3_TESTS
+	bool "Disable AHASH type 3 test cases"
+	default y
+	help
+	  Disable AHASH type 3 tests
+
 config CRYPTO_SIMD
 	tristate
 	select CRYPTO_CRYPTD
--- a/crypto/testmgr.c
+++ b/crypto/testmgr.c
@@ -376,11 +376,15 @@ static const struct testvec_config defau
 };
 
 static const struct testvec_config default_hash_testvec_configs[] = {
+#ifndef CONFIG_CRYPTO_DISABLE_AHASH_TYPE1_TESTS
+	/* Update in testmgr requires the result back whereas HW hides result from the user */
 	{
 		.name = "init+update+final aligned buffer",
 		.src_divs = { { .proportion_of_total = 10000 } },
 		.finalization_type = FINALIZATION_TYPE_FINAL,
-	}, {
+	},
+#endif
+	{
 		.name = "init+finup aligned buffer",
 		.src_divs = { { .proportion_of_total = 10000 } },
 		.finalization_type = FINALIZATION_TYPE_FINUP,
@@ -388,12 +392,17 @@ static const struct testvec_config defau
 		.name = "digest aligned buffer",
 		.src_divs = { { .proportion_of_total = 10000 } },
 		.finalization_type = FINALIZATION_TYPE_DIGEST,
-	}, {
+	},
+#ifndef CONFIG_CRYPTO_DISABLE_AHASH_TYPE1_TESTS
+	/* Update in testmgr requires the result back whereas HW hides result from the user */
+	{
 		.name = "init+update+final misaligned buffer",
 		.src_divs = { { .proportion_of_total = 10000, .offset = 1 } },
 		.finalization_type = FINALIZATION_TYPE_FINAL,
 		.key_offset = 1,
-	}, {
+	},
+#endif
+	{
 		.name = "digest buffer aligned only to alignmask",
 		.src_divs = {
 			{
@@ -405,7 +414,10 @@ static const struct testvec_config defau
 		.finalization_type = FINALIZATION_TYPE_DIGEST,
 		.key_offset = 1,
 		.key_offset_relative_to_alignmask = true,
-	}, {
+	},
+#ifndef CONFIG_CRYPTO_DISABLE_AHASH_TYPE2_TESTS
+	/* Update in testmgr requires the result back whereas HW hides result from the user */
+	{
 		.name = "init+update+update+final two even splits",
 		.src_divs = {
 			{ .proportion_of_total = 5000 },
@@ -415,7 +427,9 @@ static const struct testvec_config defau
 			},
 		},
 		.finalization_type = FINALIZATION_TYPE_FINAL,
-	}, {
+	},
+#endif
+	{
 		.name = "digest uneven misaligned splits, may sleep",
 		.req_flags = CRYPTO_TFM_REQ_MAY_SLEEP,
 		.src_divs = {
@@ -436,7 +450,10 @@ static const struct testvec_config defau
 			},
 		},
 		.finalization_type = FINALIZATION_TYPE_DIGEST,
-	}, {
+	},
+#ifndef CONFIG_CRYPTO_DISABLE_AHASH_TYPE3_TESTS
+	/* import/export are not supported by HW */
+	{
 		.name = "import/export",
 		.src_divs = {
 			{
@@ -449,6 +466,7 @@ static const struct testvec_config defau
 		},
 		.finalization_type = FINALIZATION_TYPE_FINAL,
 	}
+#endif
 };
 
 static unsigned int count_test_sg_divisions(const struct test_sg_division *divs)
