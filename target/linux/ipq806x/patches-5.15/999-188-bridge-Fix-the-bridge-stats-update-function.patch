From 5f72cdb69aae4ab810870e4f58e35f65f0821ae9 Mon Sep 17 00:00:00 2001
From: Manish Verma <quic_maniverm@quicinc.com>
Date: Wed, 8 Jun 2022 18:47:35 +0530
Subject: [PATCH] bridge: Fix the bridge stats update function

1. For updating the stats, use the current core's stats pointer
2. Hold the exclusive access to the sequence counter while updating
   the bridge stats.

Change-Id: I16d33677ee402dc4436741b630dfb9eb17caced0
Signed-off-by: Manish Verma <quic_maniverm@quicinc.com>
---
 net/bridge/br_if.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

--- a/net/bridge/br_if.c
+++ b/net/bridge/br_if.c
@@ -870,12 +870,14 @@ void br_dev_update_stats(struct net_devi
 
 	tstats = this_cpu_ptr(dev->tstats);
 
+	local_bh_disable();
 	u64_stats_update_begin(&tstats->syncp);
 	tstats->rx_packets += nlstats->rx_packets;
 	tstats->rx_bytes += nlstats->rx_bytes;
 	tstats->tx_packets += nlstats->tx_packets;
 	tstats->tx_bytes += nlstats->tx_bytes;
 	u64_stats_update_end(&tstats->syncp);
+	local_bh_enable();
 }
 EXPORT_SYMBOL_GPL(br_dev_update_stats);
 
