From ca14b5d07bb544252ee3580a2935484cad58a239 Mon Sep 17 00:00:00 2001
From: Tian Yang <tiany@codeaurora.org>
Date: Thu, 17 Aug 2017 14:25:26 -0700
Subject: [PATCH] skbuff_debug: fix 64bit arm issue

Change-Id: I825251307b09cd78abc45fe64fee26eaf43e5ea6
Signed-off-by: Casey Chen <kexinc@codeaurora.org>
Signed-off-by: Tian Yang <tiany@codeaurora.org>
---
 net/core/skbuff_debug.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/net/core/skbuff_debug.c
+++ b/net/core/skbuff_debug.c
@@ -52,7 +52,7 @@ struct skbuff_debugobj_walking {
 static int skbuff_debugobj_walkstack(struct stackframe *frame, void *p)
 {
 	struct skbuff_debugobj_walking *w = (struct skbuff_debugobj_walking *)p;
-	u32 pc = frame->pc;
+	unsigned long pc = frame->pc;
 
 	if (w->pos < DEBUG_OBJECTS_SKBUFF_STACKSIZE - 1) {
 		w->d[w->pos++] = (void *)pc;
@@ -62,7 +62,7 @@ static int skbuff_debugobj_walkstack(str
 	return -ENOENT;
 }
 
-#ifdef CONFIG_ARM
+#if defined(CONFIG_ARM) || defined(CONFIG_ARM64)
 static void skbuff_debugobj_get_stack(void **ret)
 {
 	struct stackframe frame;
@@ -72,8 +72,12 @@ static void skbuff_debugobj_get_stack(vo
 	void *p = &w;
 
 	frame.fp = (unsigned long)__builtin_frame_address(0);
-	frame.sp = current_sp;
+
+#ifdef CONFIG_ARM
 	frame.lr = (unsigned long)__builtin_return_address(0);
+	frame.sp = current_sp;
+#endif
+
 	frame.pc = (unsigned long)skbuff_debugobj_get_stack;
 
 	walk_stackframe(&frame, skbuff_debugobj_walkstack, p);
